<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rush Fantasy Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    /* … your existing CSS … (controls row pinned to bottom-left, etc.) … */
    html, body, #map { height:100%; margin:0; }
    /* bottom-left controls row, just above bottom */
    .leaflet-bottom.leaflet-left {
      display: flex !important;
      gap: 6px; bottom: 2px!important; left:2px!important;
      z-index:2000;
    }
    .leaflet-control-cal { order:1 }
    .leaflet-control-measure { order:2 }
    .leaflet-control-myscale { order:3 }
    .leaflet-control-cal,
    .leaflet-control-measure,
    .leaflet-control-myscale {
      background:#333; color:#fff; font:12px sans-serif;
      border-radius:6px; padding:4px 8px; text-align:center;
      cursor:pointer; margin:0;
    }
    .leaflet-control-cal img { width:20px; height:20px; filter:invert(1); vertical-align:middle; }
    .leaflet-control-myscale { line-height:1.2; }
    /* … rest of your CSS (bar, pinAsk, msg, etc.) unchanged … */
  </style>
</head>
<body>

  <div id="bar">
    <!-- your upload & color‐picker bar -->
    <input type="file" id="picker" accept="image/*" hidden>
    <button class="action" id="up">Upload Map</button>
    <span style="align-self:center;color:#ddd;font-size:12px">Pin:</span>
    <button class="cBtn red"    data-c="red"></button>
    <button class="cBtn blue"   data-c="blue"></button>
    <button class="cBtn green"  data-c="green"></button>
    <button class="cBtn yellow" data-c="yellow"></button>
    <button class="cBtn purple" data-c="purple"></button>
    <button class="cBtn orange" data-c="orange"></button>
  </div>

  <div id="map"></div>
  <div id="sig">Made by Rush Software</div>
  <div id="zoomPct"></div>
  <div id="msg" class="msg"><div id="msgbox" class="msgbox"></div></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getDatabase, ref, set, push,
      onChildAdded, onChildChanged, remove, onValue
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import {
      getStorage, ref as sRef,
      uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

    // — 1) DEFINE ALL HELPERS FIRST ——————————————

    // pop-up helpers
    const msg  = document.getElementById("msg"),
          box  = document.getElementById("msgbox"),
          zoomDisplay = document.getElementById("zoomPct");
    function pop(text){
      box.innerHTML = `${text}<br><button id="ok">OK</button>`;
      msg.classList.add("show");
      document.getElementById("ok").onclick = ()=> msg.classList.remove("show");
    }
    function ask(text, cb){
      box.innerHTML = `${text}<input id="v"><button id="ok">OK</button>`;
      msg.classList.add("show");
      document.getElementById("ok").onclick = ()=>{
        const v = document.getElementById("v").value.trim();
        msg.classList.remove("show");
        cb(v);
      };
    }

    // pin prompt
    function pinPrompt(latlng){
      const pt = map.latLngToContainerPoint(latlng);
      const div = document.createElement("div");
      div.className = "pinAsk";
      div.style.left = `${pt.x - 110}px`;
      div.style.top  = `${pt.y - 10}px`;
      div.innerHTML = `
        Label:<input id="t"><br>
        URL:<input id="u"><br>
        <button id="a">OK</button>
      `;
      document.body.appendChild(div);
      document.getElementById("a").onclick = ()=>{
        const lbl = document.getElementById("t").value.trim(),
              url = document.getElementById("u").value.trim();
        div.remove();
        if (!lbl) return;
        push(pinsRef, {
          x: latlng.lat,
          y: latlng.lng,
          label: lbl,
          color: currentColour,
          url
        });
      };
      map.getContainer().classList.remove("crosshair");
      map.dragging.enable();
      mode = "";
    }

    // measure/calibrate handlers
    let dragStart, line, liveTip;
    function onDown(e){
      if (mode === "pin"){ pinPrompt(e.latlng); return; }
      if (mode==="measure"||mode==="cal"){
        dragStart = e.latlng;
        map.getContainer().classList.add("crosshair");
        map.dragging.disable();
        line = L.polyline([dragStart,dragStart], {
          color: mode==="measure" ? "#0af" : "#fa0",
          weight: 2
        }).addTo(map);
        liveTip = L.popup({closeButton:false, className:"measureTip"})
                   .setLatLng(dragStart)
                   .setContent("0 "+config.unit)
                   .openOn(map);
      }
    }
    function onMove(e){
      if (!line) return;
      line.setLatLngs([dragStart, e.latlng]);
      const px = map.latLngToLayerPoint(dragStart)
                     .distanceTo(map.latLngToLayerPoint(e.latlng));
      const val = mode==="measure"
        ? (px/(config.pxPerUnit*Math.pow(2,map.getZoom()))).toFixed(1)+" "+config.unit
        : px.toFixed(0)+" px";
      liveTip.setLatLng(e.latlng).setContent(val);
    }
    function onUp(e){
      if (!line) return;
      const px = map.latLngToLayerPoint(dragStart)
                     .distanceTo(map.latLngToLayerPoint(e.latlng));
      map.removeLayer(line);
      map.closePopup(liveTip);
      line = liveTip = null;
      map.getContainer().classList.remove("crosshair");
      map.dragging.enable();

      if (mode==="cal"){
        ask(`Pixels: ${px.toFixed(0)} → real distance (e.g. 120 mi):`, v=>{
          const m = v.match(/^([\d.]+)\s*(mi|km)$/i);
          if (m){
            set(cfgRef, {
              ...config,
              pxPerUnit: px/(parseFloat(m[1])*Math.pow(2,map.getZoom())),
              unit: m[2].toLowerCase()
            });
          }
        });
      } else if (mode==="measure"){
        L.popup({ closeButton:false })
         .setLatLng(e.latlng)
         .setContent((px/(config.pxPerUnit*Math.pow(2,map.getZoom()))).toFixed(1)+" "+config.unit)
         .openOn(map);
      }
      mode = "";
    }

    // pin rendering
    function renderPin(id,p){
      const html = `
        <div style="font-weight:bold;font-size:15px">${p.label}</div>
        ${p.url?`<div><a href="${p.url}" target="_blank">Open Link</a></div>`:""}
        <div style="display:flex;gap:6px;margin-top:6px">
          <button class="editBtn">✎</button>
          <button class="delBtn" style="background:#c00;color:#fff;border:0;border-radius:4px;padding:2px 6px">✕</button>
        </div>`;
      const m = L.marker([p.x,p.y],{ icon: icons[p.color] })
                  .addTo(map).bindPopup(html);
      markers[id] = m;
      m.on("popupopen", ()=>{
        const c = m.getPopup().getElement();
        c.querySelector(".delBtn").onclick = ()=>{
          remove(ref(db,"pins/"+id));
          map.removeLayer(m);
        };
        c.querySelector(".editBtn").onclick = ()=>{
          box.innerHTML = `
            <div><b>Edit Pin</b></div>
            <input id="editLabel" value="${p.label}"><br>
            <input id="editUrl"   value="${p.url||""}"><br>
            <button id="saveBtn">Save</button>`;
          msg.classList.add("show");
          document.getElementById("saveBtn").onclick = ()=>{
            const lbl = document.getElementById("editLabel").value.trim(),
                  url = document.getElementById("editUrl").value.trim();
            set(ref(db,"pins/"+id), { x:p.x, y:p.y, label:lbl, color:p.color, url });
            msg.classList.remove("show");
          };
        };
      });
    }
    function updatePin(id,p){
      const m = markers[id];
      if (m) map.removeLayer(m);
      renderPin(id,p);
    }

    // — 2) APP CODE STARTS HERE ——————————————
    // Firebase init
    const firebaseConfig = {
      apiKey:       "AIzaSyAvOYFqN4QaygGY-vzECYZJKUBZBCjddvg",
      databaseURL:  "https://rush-fantasy-maps-default-rtdb.firebaseio.com",
      storageBucket:"rush-fantasy-maps.firebasestorage.app"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app), st = getStorage(app);
    const cfgRef  = ref(db,"config"), pinsRef = ref(db,"pins");

    // upload picker
    const pickerEl = document.getElementById("picker");
    document.getElementById("up").onclick = ()=> pickerEl.click();
    pickerEl.onchange = async e=>{
      const file = e.target.files[0];
      if (!file) return pickerEl.value="";
      pickerEl.value="";
      const img = new Image();
      img.onload = async ()=>{
        const path = `maps/${Date.now()}_${file.name}`;
        await uploadBytes(sRef(st,path), file);
        const url = await getDownloadURL(sRef(st,path));
        set(cfgRef, {
          mapUrl:    url,
          w:         img.naturalWidth,
          h:         img.naturalHeight,
          pxPerUnit: 20,
          unit:      "mi"
        });
      };
      img.src = URL.createObjectURL(file);
    };

    // marker icons
    const iconURLs = {
      red:   "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
      blue:  "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
      yellow:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-yellow.png",
      purple:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png",
      orange:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-orange.png"
    };
    const icons = {}, markers = {};
    for (let c in iconURLs) {
      icons[c] = L.icon({ iconUrl: iconURLs[c], iconSize:[25,41], iconAnchor:[12,41] });
    }
    let map, imgLayer, scaleCtl, calCtl, measureCtl, config=null, mode="", currentColour="red";

    // sync on config change
    onValue(cfgRef, snap=>{
      const d = snap.val();
      if (!d) return pop("Upload a map first.");
      config = d;

      // init map once
      if (!map){
        map = L.map("map", {
          crs: L.CRS.Simple,
          minZoom: -5,   // ← you can zoom way out now
          maxZoom: 6
        })
        .on("mousedown", onDown)
        .on("mousemove", onMove)
        .on("mouseup", onUp)
        .on("zoomend", ()=>{ buildScale(); updateZoom(); });

        onChildAdded(pinsRef,   s=>renderPin(s.key,s.val()));
        onChildChanged(pinsRef, s=>updatePin(s.key,s.val()));

        // calibrate button
        calCtl = L.control({position:"bottomleft"});
        calCtl.onAdd = ()=>{
          const el = L.DomUtil.create("div","leaflet-control-cal");
          el.title="Calibrate scale";
          el.innerHTML='<img src="https://img.icons8.com/ios-filled/50/compass.png"/>';
          L.DomEvent.disableClickPropagation(el);
          el.onclick=()=>{ mode="cal"; pop("Drag two points to calibrate."); };
          return el;
        };
        calCtl.addTo(map);

        // measure button
        measureCtl = L.control({position:"bottomleft"});
        measureCtl.onAdd = ()=>{
          const btn = L.DomUtil.create("div","leaflet-control-measure");
          btn.innerText = "Measure";
          L.DomEvent.disableClickPropagation(btn);
          btn.onclick=()=>{
            map.getContainer().classList.add("crosshair");
            map.dragging.disable();
            mode="measure";
            if (line){ map.removeLayer(line); line=null; }
          };
          return btn;
        };
        measureCtl.addTo(map);
      }

      // always swap image
      const bounds = [[0,0],[config.h,config.w]];
      if (imgLayer) map.removeLayer(imgLayer);
      imgLayer = L.imageOverlay(config.mapUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      buildScale();
      updateZoom();
    });

    function updateZoom(){
      zoomDisplay.innerText = `Zoom: ${(100 * Math.pow(2, map.getZoom())).toFixed(0)}%`;
    }
    function buildScale(){
      if (!config) return;
      if (scaleCtl) map.removeControl(scaleCtl);
      scaleCtl = L.control({position:"bottomleft"});
      scaleCtl.onAdd = ()=>{
        const div = L.DomUtil.create("div","leaflet-control-myscale");
        const zoomFac = Math.pow(2, map.getZoom()), step=50, max=500;
        const pxUnit = config.pxPerUnit * zoomFac;
        let lines="", labels="";
        for (let m=0; m<=max; m+=step){
          const x = Math.round(m * pxUnit);
          lines += `<line x1="${x}" y1="0" x2="${x}" y2="6" stroke="#fff" stroke-width="2"/>`;
        }
        [100,200,300,400,500].forEach(lab=>{
          const x = Math.round(lab * pxUnit);
          labels += `<text x="${x}" y="18" font-size="12" fill="#fff" text-anchor="middle">${lab}</text>`;
        });
        div.innerHTML = `
          <svg width="${max*pxUnit}" height="24">
            ${lines}
            ${labels}
          </svg><br>0 → ${max} ${config.unit}
        `;
        return div;
      };
      scaleCtl.addTo(map);
    }
  </script>
</body>
</html>
